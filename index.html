<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacer el Supermercado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;

        window.firebaseInit = async function() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase initialized.");

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User signed in:", userId);
                        // Hide loader and show registration form
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('registration-screen').classList.remove('hidden');
                    } else {
                        console.log("User signed out.");
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                document.getElementById('loading-text').textContent = "Error al conectar con la base de datos. Por favor, recarga la página.";
            }
        };

        window.db = db;
        window.auth = auth;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.userId = userId;
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Loading Screen -->
    <div id="loading-screen" class="flex flex-col items-center justify-center text-center p-8">
        <div class="loader"></div>
        <p id="loading-text" class="text-xl font-semibold text-gray-700 mt-4">Conectando con la base de datos...</p>
    </div>

    <!-- Registration Screen -->
    <div id="registration-screen" class="container hidden">
        <h1 class="text-3xl font-bold mb-4">¡Bienvenido!</h1>
        <p class="text-gray-600 mb-8">Por favor, ingresa tus datos para comenzar el desafío.</p>
        <form id="registration-form" class="flex flex-col items-center gap-4">
            <input type="text" id="student-name" class="p-2 rounded-lg w-full md:w-2/3 border border-gray-300" placeholder="Nombre completo" required>
            <input type="text" id="student-group" class="p-2 rounded-lg w-full md:w-2/3 border border-gray-300" placeholder="Grupo" required>
            <button type="submit" class="mt-4 px-6 py-3 bg-blue-500 text-white font-bold rounded-full shadow-lg hover:bg-blue-600 transition">
                Comenzar Desafío
            </button>
        </form>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="container hidden">
        <div class="flex justify-between items-center mb-4">
            <div id="challenge-counter" class="text-lg font-semibold text-gray-700">Desafío 1 de 5</div>
            <div id="timer" class="text-xl font-bold text-red-500">90s</div>
        </div>
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Hacer el Supermercado</h1>
        <p class="text-gray-600 mb-8">¡Practica tus sumas! Compra los productos indicados y calcula el total.</p>

        <div class="product-list">
            <!-- Products will be generated here by JavaScript -->
        </div>

        <div id="challenge-box" class="challenge">
            <!-- Challenge text will be generated here -->
        </div>

        <div class="flex flex-col items-center gap-4">
            <label for="user-answer" class="text-xl font-medium text-gray-700">Tu respuesta:</label>
            <input type="number" id="user-answer" class="w-full sm:w-1/2 md:w-1/3 p-2 rounded-lg text-center" placeholder="Introduce el total">
            <button id="check-button" class="mt-4 px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600 transition">
                Verificar
            </button>
        </div>
        
        <div id="result-message" class="result-message hidden mt-4"></div>
        
    </div>
    
    <!-- Results Screen -->
    <div id="results-screen" class="container hidden">
        <h1 class="text-3xl font-bold mb-4">¡Desafío Completado!</h1>
        <p class="text-xl text-gray-700 mb-2">Tu puntuación final es:</p>
        <p id="final-score" class="text-5xl font-extrabold text-green-600 mb-8"></p>
        <button id="save-score-button" class="px-6 py-3 bg-blue-500 text-white font-bold rounded-full shadow-lg hover:bg-blue-600 transition">
            Guardar Puntuación
        </button>
        <button id="view-all-scores-button" class="mt-4 px-6 py-3 bg-purple-500 text-white font-bold rounded-full shadow-lg hover:bg-purple-600 transition">
            Ver todas las puntuaciones
        </button>
    </div>

    <!-- Scores Screen -->
    <div id="scores-screen" class="container hidden">
        <h1 class="text-3xl font-bold mb-4">Puntuaciones de los Alumnos</h1>
        <table class="min-w-full bg-white rounded-lg shadow-md mb-4">
            <thead>
                <tr class="bg-gray-200">
                    <th class="py-2 px-4 text-left text-gray-600 font-bold">Nombre</th>
                    <th class="py-2 px-4 text-left text-gray-600 font-bold">Grupo</th>
                    <th class="py-2 px-4 text-left text-gray-600 font-bold">Puntuación</th>
                    <th class="py-2 px-4 text-left text-gray-600 font-bold">Fecha</th>
                </tr>
            </thead>
            <tbody id="scores-table-body">
                <!-- Scores will be loaded here -->
            </tbody>
        </table>
        <button id="back-to-results-button" class="mt-4 px-6 py-3 bg-blue-500 text-white font-bold rounded-full shadow-lg hover:bg-blue-600 transition">
            Volver a los resultados
        </button>
    </div>

    <!-- Modal for messages -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-4"></h2>
            <p id="modal-text" class="text-gray-700 mb-6"></p>
            <button id="close-modal-button" class="px-6 py-2 bg-blue-500 text-white rounded-full">Cerrar</button>
        </div>
    </div>

    <script src="supermercado.js" type="module"></script>
</body>
</html>
